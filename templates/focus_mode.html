{% extends 'base.html' %}
{% block title %}Focus Mode - {{ task.title }}{% endblock %}

{% block content %}
<style>
  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
  }

  .focus-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
  }

  .task-card {
    background: white;
    border-radius: 20px;
    padding: 3rem;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
  }

  .timer-display {
    font-size: 4rem;
    font-weight: bold;
    color: #667eea;
    text-align: center;
    margin: 2rem 0;
    font-family: 'Courier New', monospace;
  }

  .task-title {
    font-size: 2.5rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 1rem;
    text-align: center;
  }

  .subtasks-section {
    margin: 2rem 0;
  }

  .subtask-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    margin: 0.5rem 0;
    background: #f8f9fa;
    border-radius: 10px;
    transition: all 0.3s ease;
  }

  .subtask-item:hover {
    background: #e9ecef;
  }

  .subtask-checkbox {
    margin-right: 1rem;
    transform: scale(1.5);
  }

  .subtask-text {
    font-size: 1.2rem;
    flex-grow: 1;
  }

  .subtask-text.completed {
    text-decoration: line-through;
    color: #6c757d;
  }

  .controls {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
  }

  .btn-control {
    padding: 1rem 2rem;
    font-size: 1.2rem;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-primary {
    background: #667eea;
    color: white;
  }

  .btn-danger {
    background: #dc3545;
    color: white;
  }

  .btn-success {
    background: #28a745;
    color: white;
  }

  .progress-bar {
    width: 100%;
    height: 10px;
    background: #e9ecef;
    border-radius: 5px;
    overflow: hidden;
    margin: 1rem 0;
  }

  .progress-fill {
    height: 100%;
    background: #667eea;
    transition: width 0.3s ease;
  }

  .exit-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
  }
</style>

<div class="focus-container">
  <a href="{{ url_for('tasks') }}" class="btn btn-secondary exit-btn">Exit Focus Mode</a>
  
  <div class="task-card">
    <h1 class="task-title">{{ task.title }}</h1>
    
    <div class="timer-display" id="timer">
      {% if task.duration_minutes %}
        {{ task.duration_minutes }}:00
      {% else %}
        No Timer Set
      {% endif %}
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
    </div>

    {% if task.subtasks %}
    <div class="subtasks-section">
      <h3>Subtasks</h3>
      {% for subtask in task.subtasks %}
      <div class="subtask-item">
        <input type="checkbox" class="subtask-checkbox" 
               data-subtask-index="{{ loop.index0 }}"
               {% if subtask.is_done %}checked{% endif %}>
        <span class="subtask-text {% if subtask.is_done %}completed{% endif %}">
          {{ subtask.title }}
        </span>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    <div class="controls">
      {% if task.duration_minutes %}
      <button class="btn-control btn-primary" id="start-timer">Start Timer</button>
      <button class="btn-control btn-danger" id="pause-timer" style="display: none;">Pause</button>
      <button class="btn-control btn-success" id="complete-task">Complete Task</button>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const taskId = '{{ task.id }}';
  const durationMinutes = {{ task.duration_minutes or 0 }};
  let timeLeft = durationMinutes * 60;
  let timerInterval = null;
  let isRunning = false;

  const timerDisplay = document.getElementById('timer');
  const startBtn = document.getElementById('start-timer');
  const pauseBtn = document.getElementById('pause-timer');
  const completeBtn = document.getElementById('complete-task');
  const progressFill = document.getElementById('progress-fill');

  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  function updateTimer() {
    timerDisplay.textContent = formatTime(timeLeft);
    const progress = ((durationMinutes * 60 - timeLeft) / (durationMinutes * 60)) * 100;
    progressFill.style.width = Math.min(progress, 100) + '%';

    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      timerDisplay.textContent = 'Time\'s Up!';
      timerDisplay.style.color = '#dc3545';
      startBtn.style.display = 'none';
      pauseBtn.style.display = 'none';
      completeBtn.style.display = 'inline-block';
    }
  }

  function startTimer() {
    if (!isRunning) {
      isRunning = true;
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimer();
      }, 1000);
      
      startBtn.style.display = 'none';
      pauseBtn.style.display = 'inline-block';
    }
  }

  function pauseTimer() {
    if (isRunning) {
      isRunning = false;
      clearInterval(timerInterval);
      
      startBtn.style.display = 'inline-block';
      pauseBtn.style.display = 'none';
    }
  }

  function completeTask() {
    // Mark task as complete
    window.location.href = `/toggle/${taskId}`;
  }

  // Event listeners
  if (startBtn) startBtn.addEventListener('click', startTimer);
  if (pauseBtn) pauseBtn.addEventListener('click', pauseTimer);
  if (completeBtn) completeBtn.addEventListener('click', completeTask);

  // Subtask checkbox handling
  document.querySelectorAll('.subtask-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const subtaskIndex = this.dataset.subtaskIndex;
      const isChecked = this.checked;
      
      // Update subtask status
      fetch(`/toggle_subtask/${taskId}/${subtaskIndex}`, {
        method: 'GET'
      }).then(() => {
        const textElement = this.nextElementSibling;
        if (isChecked) {
          textElement.classList.add('completed');
        } else {
          textElement.classList.remove('completed');
        }
      });
    });
  });

  // Initialize
  updateTimer();
});
</script>
{% endblock %}
